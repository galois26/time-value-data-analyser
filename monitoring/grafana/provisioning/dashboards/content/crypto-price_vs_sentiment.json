{
  "uid": "crypto-price-vs-sentiment",
  "title": "Crypto â€¢ BTC Price vs News Sentiment",
  "schemaVersion": 38,
  "version": 2,
  "timezone": "browser",
  "tags": ["crypto", "btc", "sentiment"],
  "templating": {
    "list": [
      {
        "name": "env",
        "label": "Environment",
        "type": "custom",
        "query": "prod,dev",
        "current": { "text": "prod", "value": "prod" }
      },
      {
        "name": "currency",
        "label": "Currency",
        "type": "custom",
        "query": "USD,EUR",
        "current": { "text": "USD", "value": "USD" }
      },
      {
        "name": "query",
        "label": "News Query",
        "type": "custom",
        "query": "bitcoin,crypto",
        "current": { "text": "bitcoin", "value": "bitcoin" }
      },
      {
        "name": "source",
        "label": "Source",
        "type": "query",
        "datasource": "VictoriaMetrics",
        "refresh": 2,
        "includeAll": true,
        "multi": true,
        "query": "label_values(news_sentiment_avg{env=\"$env\", q=\"$query\"}, source)",
        "current": { "text": "All", "value": "$__all" }
      },
      {
        "name": "sent_window",
        "label": "Sentiment Window",
        "type": "custom",
        "query": "5m,15m,1h,6h,24h",
        "current": { "text": "1h", "value": "1h" }
      },
      {
        "name": "price_window",
        "label": "Price Smoothing",
        "type": "custom",
        "query": "5m,15m,1h",
        "current": { "text": "15m", "value": "15m" }
      }
    ]
  },
  "panels": [
    {
      "type": "timeseries",
      "title": "BTC Price vs Sentiment (dual axis)",
      "gridPos": { "x": 0, "y": 0, "w": 24, "h": 10 },
      "datasource": "VictoriaMetrics",
      "fieldConfig": {
        "defaults": {},
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "BTC Price" },
            "properties": [
              { "id": "unit", "value": "currency" },
              { "id": "decimals", "value": 2 },
              { "id": "custom.axisPlacement", "value": "left" }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "Sentiment (avg)" },
            "properties": [
              { "id": "unit", "value": "none" },
              { "id": "decimals", "value": 2 },
              { "id": "custom.axisPlacement", "value": "right" },
              { "id": "custom.axisLabel", "value": "Sentiment (-1..1)" },
              { "id": "custom.axisSoftMin", "value": -1 },
              { "id": "custom.axisSoftMax", "value": 1 }
            ]
          }
        ]
      },
      "options": { "legend": { "showLegend": true, "placement": "bottom" }, "tooltip": { "mode": "single" } },
      "targets": [
        {
          "refId": "A",
          "legendFormat": "BTC Price",
          "expr": "avg_over_time(btc_price{currency=\"$currency\"}[$price_window])"
        },
        {
          "refId": "B",
          "legendFormat": "{{source}}",
          "expr": "avg_over_time(news_sentiment_avg{env=\"$env\", q=\"$query\", source=~\"$source\"}[$sent_window])"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "News Volume by Source (rolling count)",
      "gridPos": { "x": 0, "y": 10, "w": 14, "h": 8 },
      "datasource": "VictoriaMetrics",
      "options": { "legend": { "showLegend": true, "placement": "bottom" }, "tooltip": { "mode": "multi" } },
      "targets": [
        {
          "refId": "A",
          "legendFormat": "Avg Sentiment {{source}}",
          "expr": "sum by (source) (sum_over_time(news_sentiment_count{env=\"$env\", q=\"$query\", source=~\"$source\"}[$sent_window]))"
        }
      ]
    },
    {
      "type": "stat",
      "title": "Latest BTC Price",
      "gridPos": { "x": 14, "y": 10, "w": 5, "h": 8 },
      "datasource": "VictoriaMetrics",
      "fieldConfig": { "defaults": { "unit": "currency", "decimals": 2 } },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] } },
      "targets": [ { "refId": "A", "expr": "btc_price{currency=\"$currency\"}" } ]
    },
    {
      "type": "stat",
      "title": "Avg Sentiment (window)",
      "gridPos": { "x": 19, "y": 10, "w": 5, "h": 8 },
      "datasource": "VictoriaMetrics",
      "fieldConfig": { "defaults": { "decimals": 2 } },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] } },
      "targets": [
        { "refId": "A", "expr": "avg_over_time(news_sentiment_avg{env=\"$env\", q=\"$query\", source=~\"$source\"}[$sent_window])" }
      ]
    },
    {
      "type": "table",
      "title": "Top Sources (avg sentiment & count, window)",
      "gridPos": { "x": 0, "y": 18, "w": 24, "h": 8 },
      "datasource": "VictoriaMetrics",
      "options": { "showHeader": true },
      "targets": [
        {
          "refId": "A",
          "expr": "topk(10, avg_over_time(news_sentiment_avg{env=\"$env\", q=\"$query\"}[$sent_window]))",
          "legendFormat": "{{source}}"
        },
        {
          "refId": "B",
          "expr": "sum by (source) (sum_over_time(news_sentiment_count{env=\"$env\", q=\"$query\"}[$sent_window]))",
          "legendFormat": "{{source}}"
        }
      ],
      "transformations": [
        { "id": "seriesToColumns" },
        { "id": "organize", "options": { "renameByName": { "A": "Avg Sentiment", "B": "Count" } } }
      ]
    },
    {
      "type": "logs",
      "title": "Recent Articles (matching filters)",
      "gridPos": { "x": 0, "y": 26, "w": 24, "h": 10 },
      "datasource": "Loki",
      "options": {
        "showTime": true,
        "enableLogDetails": true,
        "dedupStrategy": "none",
        "wrapLogMessage": true,
        "prettifyLogMessage": true
      },
      "targets": [
        {
          "refId": "L1",
          "expr": "{job=\"newsdata\", env=\"$env\", q=\"$query\", source=~\"$source\"} | json | line_format \"{{.pubDate}} | {{.source_id}} | {{.language}} | {{if .sentiment}}{{printf \\\"%.2f\\\" .sentiment}}{{end}} | {{.title}} | {{.link}}\"",
          "legendFormat": ""
        }
      ]
    }
  ]
}